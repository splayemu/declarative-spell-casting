<!DOCTYPE html>
<head>	
	<script type="text/javascript" src="http://cdn.craftycomponents.com/crafty-release.js"></script>
</head>
<body>
	<script type="text/javascript">

// quick fix to log messages
function log(msg) {
    setTimeout(function() {
        throw new Error(msg);
    }, 0);
}

/* game components */
Crafty.c("Player", {
	init: function() {
		//this.color(this.color);
		//this.bind('EnterFrame', function () {
			this.bind('mousemove', function(e) {
		//	if(e.parent_id == this) {
		//		this.mana -= e.manacost;
		//	}
				log("Player Mana: " + this.mana);
			});
		//});
	},
	
	// constructor for the player
	// Mana - the player will have a static amount of mana that is used to cast spells. 
	//	      When mana reaches 0, all of his/her spells disappear
	// Mana Regeneration - how much mana will regen per game tick
	// Spells - all the active spells this player has cast
	player: function(mana, mana_regeneration) {
		this.mana = mana;
		this.mana_regeneration = mana_regeneration;
		this.spells = {};
		log("Mana " + this.mana);
		// "spellcast" gets triggered every time this player casts a spell
		// 		- Reduces the current mana of the player
		//		- 

		return this;
	}

});



/* game components */
Crafty.c("Projectile", {
	init: function() {
		this.requires('2D');
		this.requires('Collision');
		//this.color(this.color);
	},
	
	// constructor for the projectile
	projectile: function(size, xStartingPos, yStartingPos, direction, speed) {
		this.attr({ x: xStartingPos, y: yStartingPos, w: size, h: size, 
			dX: Math.sin(direction) * speed, //Crafty.math.randomInt(2, 5) * xSpeed, 
			dY: Math.cos(direction) * speed}) //Crafty.math.randomInt(2, 5) * ySpeed})
		.bind('EnterFrame', function () {
			//hit floor or roof
			if (this.y <= 0 || this.y >= 290)
				this.destroy();

			if (this.x <= 0 || this.x >= 590)
				this.destroy();

			this.x += this.dX;
			this.y += this.dY;
		})
		//.onHit('Player1', function () {
		//	this.dX *= -1;
		//})
		return this;
	}

});

Crafty.c("Spell", {
	init: function() {
		this.trigger("spellcast");
		//log("initializing the spell");
	},
	
	// constructor for spell
	spell: function(name, parent, mana_cost) {
		this.name = name;
		this.parent = parent;
		this.mana_cost = mana_cost;
		return this;
	},
});
/* end game components */

/* general purpose global functions */
// need getters for the mouse position and player position
function getMouseX() {
	var mousepos = Crafty("MousePos");
	return mousepos._x;
}

function getMouseY() {
	var mousepos = Crafty("MousePos");
	return mousepos._y;
}

function getMyX() {
	var player1 = Crafty("Player1");
	return player1._x;
}

function getMyY() {
	var player1 = Crafty("Player1");
	return player1._y;
}
/* end general purpose global functions */



function init() {
	Crafty.init(600, 300);
	Crafty.background('rgb(127,127,127)');	
	
	var mousepos = Crafty.e("MousePos, DOM, 2D, Text")
		.attr({ x: 20, y: 20, w: 100, h: 20 })
		//.text("(0,0)");
	
	//Main character
	var player1 = Crafty.e("Player, Player1, 2D, DOM, Color, Keyboard, Multiway")
		.player(100,0)
		.color('rgb(0,255,0)')
		.attr({ x: 300, y: 150, w: 25, h: 25 })
		.multiway(4, {W: -90, S: 90, D: 0, A: 180})
		.bind("KeyDown", function(e) {
			if (this.isDown('SPACE')) {
				//traverse_grammar_tree(root_node);
				mousepos_x = getMouseX();
				mousepos_y = getMouseY();
				my_x = getMyX();
				my_y = getMyY();
				var speed = 3;
				var direction = Math.atan2(mousepos_x - my_x, mousepos_y - my_y );
				Crafty.e("2D, DOM, Collision, Projectile, Color, Spell")
					.projectile(8, my_x, my_y , direction, speed)
					.color('rgb(255,10,10)')
					.spell("fireball", this, 10)
                                        .trigger("spellcast")
			}
		});

	Crafty.addEvent(this, "spellcast", function(e) {
		log("spell is cast");
	});
		
	Crafty.addEvent(this, "mousemove", function(e) {
		//var pos = Crafty.DOM.translate(e.clientX, e.clientY);	
		//var direction = (Math.atan2(e.clientY - player1._y, e.clientX - player1._x));
		//mousepos.text("(" + Math.cos(direction) + "," + Math.sin(direction) + ")");
		//mousepos.text("(" + direction + ")");
		mousepos.attr({ x: e.clientX , y: e.clientY, w: 100, h: 20 }); 
		//me.rotation = ~~(Math.atan2(pos.y - me._y, pos.x - me._x) * (180 / Math.PI)) + 90;
	});
	

		
};

init()


	</script>
</body>
</html>
